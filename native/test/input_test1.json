{"content": "require \"active_support/core_ext/object/json\"\nrequire \"active_support/core_ext/module/delegation\"\n\nmodule ActiveSupport\n  class \u003c\u003c self\n    delegate :use_standard_json_time_format, :use_standard_json_time_format=,\n      :time_precision, :time_precision=,\n      :escape_html_entities_in_json, :escape_html_entities_in_json=,\n      :json_encoder, :json_encoder=,\n      to: :'ActiveSupport::JSON::Encoding'\n  end\n\n  module JSON\n    # Dumps objects in JSON (JavaScript Object Notation).\n    # See http://www.json.org for more info.\n    #\n    #   ActiveSupport::JSON.encode({ team: 'rails', players: '36' })\n    #   # =\u003e \"{\\\"team\\\":\\\"rails\\\",\\\"players\\\":\\\"36\\\"}\"\n    def self.encode(value, options = nil)\n      Encoding.json_encoder.new(options).encode(value)\n    end\n\n    module Encoding #:nodoc:\n      class JSONGemEncoder #:nodoc:\n        attr_reader :options\n\n        def initialize(options = nil)\n          @options = options || {}\n        end\n\n        # Encode the given object into a JSON string\n        def encode(value)\n          stringify jsonify value.as_json(options.dup)\n        end\n\n        private\n          # Rails does more escaping than the JSON gem natively does (we\n          # escape \\u2028 and \\u2029 and optionally \u003e, \u003c, \u0026 to work around\n          # certain browser problems).\n          ESCAPED_CHARS = {\n            \"\\u2028\" =\u003e '\\u2028',\n            \"\\u2029\" =\u003e '\\u2029',\n            \"\u003e\"      =\u003e '\\u003e',\n            \"\u003c\"      =\u003e '\\u003c',\n            \"\u0026\"      =\u003e '\\u0026',\n            }\n\n          ESCAPE_REGEX_WITH_HTML_ENTITIES = /[\\u2028\\u2029\u003e\u003c\u0026]/u\n          ESCAPE_REGEX_WITHOUT_HTML_ENTITIES = /[\\u2028\\u2029]/u\n\n          # This class wraps all the strings we see and does the extra escaping\n          class EscapedString \u003c String #:nodoc:\n            def to_json(*)\n              if Encoding.escape_html_entities_in_json\n                super.gsub ESCAPE_REGEX_WITH_HTML_ENTITIES, ESCAPED_CHARS\n              else\n                super.gsub ESCAPE_REGEX_WITHOUT_HTML_ENTITIES, ESCAPED_CHARS\n              end\n            end\n\n            def to_s\n              self\n            end\n          end\n\n          # Mark these as private so we don't leak encoding-specific constructs\n          private_constant :ESCAPED_CHARS, :ESCAPE_REGEX_WITH_HTML_ENTITIES,\n            :ESCAPE_REGEX_WITHOUT_HTML_ENTITIES, :EscapedString\n\n          # Convert an object into a \"JSON-ready\" representation composed of\n          # primitives like Hash, Array, String, Numeric,\n          # and +true+/+false+/+nil+.\n          # Recursively calls #as_json to the object to recursively build a\n          # fully JSON-ready object.\n          #\n          # This allows developers to implement #as_json without having to\n          # worry about what base types of objects they are allowed to return\n          # or having to remember to call #as_json recursively.\n          #\n          # Note: the +options+ hash passed to +object.to_json+ is only passed\n          # to +object.as_json+, not any of this method's recursive +#as_json+\n          # calls.\n          def jsonify(value)\n            case value\n            when String\n              EscapedString.new(value)\n            when Numeric, NilClass, TrueClass, FalseClass\n              value.as_json\n            when Hash\n              Hash[value.map { |k, v| [jsonify(k), jsonify(v)] }]\n            when Array\n              value.map { |v| jsonify(v) }\n            else\n              jsonify value.as_json\n            end\n          end\n\n          # Encode a \"jsonified\" Ruby data structure using the JSON gem\n          def stringify(jsonified)\n            ::JSON.generate(jsonified, quirks_mode: true, max_nesting: false)\n          end\n      end\n\n      class \u003c\u003c self\n        # If true, use ISO 8601 format for dates and times. Otherwise, fall back\n        # to the Active Support legacy format.\n        attr_accessor :use_standard_json_time_format\n\n        # If true, encode \u003e, \u003c, \u0026 as escaped unicode sequences (e.g. \u003e as \\u003e)\n        # as a safety measure.\n        attr_accessor :escape_html_entities_in_json\n\n        # Sets the precision of encoded time values.\n        # Defaults to 3 (equivalent to millisecond precision)\n        attr_accessor :time_precision\n\n        # Sets the encoder used by Rails to encode Ruby objects into JSON strings\n        # in +Object#to_json+ and +ActiveSupport::JSON.encode+.\n        attr_accessor :json_encoder\n      end\n\n      self.use_standard_json_time_format = true\n      self.escape_html_entities_in_json  = true\n      self.json_encoder = JSONGemEncoder\n      self.time_precision = 3\n    end\n  end\nend\n"}
